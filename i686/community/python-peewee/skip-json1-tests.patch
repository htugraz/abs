From d6e4b1f9b0e63f523f5997b7f624c71ff7d344ff Mon Sep 17 00:00:00 2001
From: Charles Leifer <coleifer@gmail.com>
Date: Sat, 21 Nov 2015 20:20:58 -0600
Subject: [PATCH] Check json1 installed, fixes #767

---
 playhouse/tests/test_sqlite_ext.py | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/playhouse/tests/test_sqlite_ext.py b/playhouse/tests/test_sqlite_ext.py
index 634b644..e5c76d2 100644
--- a/playhouse/tests/test_sqlite_ext.py
+++ b/playhouse/tests/test_sqlite_ext.py
@@ -161,7 +161,21 @@ class TestVirtualModelChild(TestVirtualModel):
     pass
 
 
-@skip_unless(lambda: sqlite3.sqlite_version_info >= (3, 9, 0))
+def json_installed():
+    if sqlite3.sqlite_version_info < (3, 9, 0):
+        return False
+    # Test in-memory DB to determine if the FTS5 extension is installed.
+    tmp_db = sqlite3.connect(':memory:')
+    try:
+        tmp_db.execute('select json(?)', (1337,))
+    except:
+        return False
+    finally:
+        tmp_db.close()
+    return True
+
+
+@skip_unless(json_installed)
 class TestJSONField(ModelTestCase):
     requires = [
         APIData,
