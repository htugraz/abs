From 2f8c902f4b9f86c8e3a6be758d78908e8cb50d0d Mon Sep 17 00:00:00 2001
From: "Jan Alexander Steffens (heftig)" <jan.steffens@gmail.com>
Date: Wed, 28 Oct 2015 23:27:19 +0100
Subject: [PATCH] Add systemd user services

Follows the code in GVFS.
---
 search-provider/Makefile.am                        | 16 ++++++++++-----
 ...gnome-control-center-search-provider.service.in |  7 +++++++
 ...g.gnome.ControlCenter.SearchProvider.service.in |  3 ++-
 shell/Makefile.am                                  | 24 ++++++++++++++--------
 shell/gnome-control-center.service.in              |  7 +++++++
 shell/org.gnome.ControlCenter.service.in           |  1 +
 6 files changed, 44 insertions(+), 14 deletions(-)
 create mode 100644 search-provider/gnome-control-center-search-provider.service.in
 create mode 100644 shell/gnome-control-center.service.in

diff --git a/search-provider/Makefile.am b/search-provider/Makefile.am
index 2314d66..864d895 100644
--- a/search-provider/Makefile.am
+++ b/search-provider/Makefile.am
@@ -38,17 +38,23 @@ gnome_control_center_search_provider_LDADD =	\
 	$(top_builddir)/shell/libshell.la	\
 	$(SHELL_LIBS)
 
-CLEANFILES = $(BUILT_SOURCES) $(service_DATA)
+CLEANFILES = $(BUILT_SOURCES) $(service_DATA) $(systemd_user_DATA)
 
 servicedir = $(datadir)/dbus-1/services
 service_DATA = $(service_in_files:.service.in=.service)
-service_in_files = 				\
-	org.gnome.ControlCenter.SearchProvider.service.in
+service_in_files = org.gnome.ControlCenter.SearchProvider.service.in
 
-org.gnome.ControlCenter.SearchProvider.service: org.gnome.ControlCenter.SearchProvider.service.in Makefile
+systemd_userdir = ${prefix}/lib/systemd/user
+systemd_user_DATA = $(systemd_user_in_files:.service.in=.service)
+systemd_user_in_files = gnome-control-center-search-provider.service.in
+
+$(service_DATA): $(service_in_files) Makefile
 	$(AM_V_GEN) sed -e "s|\@libexecdir\@|$(libexecdir)|" $< > $@
 
-EXTRA_DIST = $(service_in_files) org.gnome.ShellSearchProvider2.xml
+$(systemd_user_DATA): $(systemd_user_in_files) Makefile
+	$(AM_V_GEN) sed -e "s|\@libexecdir\@|$(libexecdir)|" $< > $@
+
+EXTRA_DIST = $(service_in_files) $(systemd_user_in_files) org.gnome.ShellSearchProvider2.xml
 
 searchproviderdir = $(datadir)/gnome-shell/search-providers
 dist_searchprovider_DATA = gnome-control-center-search-provider.ini
diff --git a/search-provider/gnome-control-center-search-provider.service.in b/search-provider/gnome-control-center-search-provider.service.in
new file mode 100644
index 0000000..4e56af1
--- /dev/null
+++ b/search-provider/gnome-control-center-search-provider.service.in
@@ -0,0 +1,7 @@
+[Unit]
+Description=GNOME Control Center Search Provider
+
+[Service]
+Type=dbus
+BusName=org.gnome.ControlCenter.SearchProvider
+ExecStart=@libexecdir@/gnome-control-center-search-provider
diff --git a/search-provider/org.gnome.ControlCenter.SearchProvider.service.in b/search-provider/org.gnome.ControlCenter.SearchProvider.service.in
index 81dd0c8..79b54a2 100644
--- a/search-provider/org.gnome.ControlCenter.SearchProvider.service.in
+++ b/search-provider/org.gnome.ControlCenter.SearchProvider.service.in
@@ -1,3 +1,4 @@
 [D-BUS Service]
 Name=org.gnome.ControlCenter.SearchProvider
-Exec=@libexecdir@/gnome-control-center-search-provider
\ No newline at end of file
+Exec=@libexecdir@/gnome-control-center-search-provider
+SystemdService=gnome-control-center-search-provider.service
diff --git a/shell/Makefile.am b/shell/Makefile.am
index f72ebe9..bf78fd3 100644
--- a/shell/Makefile.am
+++ b/shell/Makefile.am
@@ -91,12 +91,19 @@ if BUILD_BLUETOOTH
 gnome_control_center_LDADD += $(top_builddir)/panels/bluetooth/libbluetooth.la
 endif
 
-# Dbus service file
-servicefiledir = $(datadir)/dbus-1/services
-servicefile_in_files = org.gnome.ControlCenter.service.in
-servicefile_DATA = $(servicefile_in_files:.service.in=.service)
-$(servicefile_DATA): $(servicefile_in_files) Makefile
-	$(AM_V_GEN) sed -e 's|[@]bindir[@]|$(bindir)|' $< > $@
+servicedir = $(datadir)/dbus-1/services
+service_DATA = $(service_in_files:.service.in=.service)
+service_in_files = org.gnome.ControlCenter.service.in
+
+systemd_userdir = ${prefix}/lib/systemd/user
+systemd_user_DATA = $(systemd_user_in_files:.service.in=.service)
+systemd_user_in_files = gnome-control-center.service.in
+
+$(service_DATA): $(service_in_files) Makefile
+	$(AM_V_GEN) sed -e "s|\@bindir\@|$(bindir)|" $< > $@
+
+$(systemd_user_DATA): $(systemd_user_in_files) Makefile
+	$(AM_V_GEN) sed -e "s|\@bindir\@|$(bindir)|" $< > $@
 
 sysdir = $(datadir)/applications
 sys_in_files = gnome-control-center.desktop.in
@@ -111,11 +118,12 @@ completions/gnome-control-center: completions/gnome-control-center.in list-panel
 
 EXTRA_DIST =					\
 	gnome-control-center.desktop.in.in	\
-	$(servicefile_in_files)                 \
+	$(service_in_files)			\
+	$(systemd_user_in_files)		\
 	$(completion_in_files)			\
 	list-panel.sh
 
-CLEANFILES = $(BUILT_SOURCES) $(completion_DATA) $(servicefile_DATA)
+CLEANFILES = $(BUILT_SOURCES) $(completion_DATA) $(service_DATA) $(systemd_user_DATA)
 DISTCLEANFILES = gnome-control-center.desktop gnome-control-center.desktop.in
 
 noinst_PROGRAMS = test-hostname
diff --git a/shell/gnome-control-center.service.in b/shell/gnome-control-center.service.in
new file mode 100644
index 0000000..bd80ee0
--- /dev/null
+++ b/shell/gnome-control-center.service.in
@@ -0,0 +1,7 @@
+[Unit]
+Description=GNOME Control Center
+
+[Service]
+Type=dbus
+BusName=org.gnome.ControlCenter
+ExecStart=@bindir@/gnome-control-center
diff --git a/shell/org.gnome.ControlCenter.service.in b/shell/org.gnome.ControlCenter.service.in
index a515129..1f2489d 100644
--- a/shell/org.gnome.ControlCenter.service.in
+++ b/shell/org.gnome.ControlCenter.service.in
@@ -1,3 +1,4 @@
 [D-BUS Service]
 Name=org.gnome.ControlCenter
 Exec=@bindir@/gnome-control-center
+SystemdService=gnome-control-center.service
-- 
2.6.1

