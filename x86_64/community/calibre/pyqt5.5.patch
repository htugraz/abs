From 8f75f2d5ad17ef35d52a9dc1a137c36d42e8454e Mon Sep 17 00:00:00 2001
From: Kovid Goyal <kovid@kovidgoyal.net>
Date: Thu, 23 Jul 2015 11:47:53 +0530
Subject: [PATCH] More compatibility fixes for PyQt 5.5

---
 src/calibre/gui2/library/alternate_views.py | 2 +-
 src/calibre/gui2/library/delegates.py       | 4 ++--
 src/calibre/gui2/library/views.py           | 2 +-
 3 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/src/calibre/gui2/library/alternate_views.py b/src/calibre/gui2/library/alternate_views.py
index f492343..813ff48 100644
--- a/src/calibre/gui2/library/alternate_views.py
+++ b/src/calibre/gui2/library/alternate_views.py
@@ -101,7 +101,7 @@ def drag_data(self):
     selected = self.get_selected_ids()
     ids = ' '.join(map(str, selected))
     md = QMimeData()
-    md.setData('application/calibre+from_library', ids)
+    md.setData('application/calibre+from_library', ids.encode('utf-8'))
     fmt = prefs['output_format']
 
     def url_for_id(i):
diff --git a/src/calibre/gui2/library/delegates.py b/src/calibre/gui2/library/delegates.py
index eed3ed8..5e0344c 100644
--- a/src/calibre/gui2/library/delegates.py
+++ b/src/calibre/gui2/library/delegates.py
@@ -55,11 +55,11 @@ def updateEditorGeometry(self, editor, option, index):
         # Now get the size of the combo/spinner arrows and add them to the needed width
         if isinstance(editor, (QComboBox, QDateTimeEdit)):
             r = style.subControlRect(QStyle.CC_ComboBox, QStyleOptionComboBox(),
-                                      QStyle.SC_ComboBoxArrow)
+                                      QStyle.SC_ComboBoxArrow, editor)
             new_width += r.width()
         elif isinstance(editor, (QSpinBox, QDoubleSpinBox)):
             r = style.subControlRect(QStyle.CC_SpinBox, QStyleOptionSpinBox(),
-                                  QStyle.SC_SpinBoxUp)
+                                  QStyle.SC_SpinBoxUp, editor)
             new_width += r.width()
 
         # Compute the maximum we can show if we consume the entire viewport
diff --git a/src/calibre/gui2/library/views.py b/src/calibre/gui2/library/views.py
index 008721e..7e1743d 100644
--- a/src/calibre/gui2/library/views.py
+++ b/src/calibre/gui2/library/views.py
@@ -1098,7 +1098,7 @@ def drag_data(self):
         rows = self.selectionModel().selectedRows()
         paths = [force_unicode(p, enc=filesystem_encoding) for p in m.paths(rows) if p]
         md = QMimeData()
-        md.setData('application/calibre+from_device', 'dummy')
+        md.setData('application/calibre+from_device', b'dummy')
         md.setUrls([QUrl.fromLocalFile(p) for p in paths])
         drag = QDrag(self)
         drag.setMimeData(md)
